<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Münazara Arenası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .dark body { background-color: #111827; }
        .text-contrast { color: #1f2937; }
        .dark .text-contrast { color: #f9fafb; }
        .text-subtle { color: #4b5563; }
        .dark .text-subtle { color: #9ca3af; }
        .moon-icon { transform: translate(-0.5px, 0); }
        .theme-toggle-circle { transition: transform 0.3s ease-in-out; }
        .theme-toggle-circle.light { transform: translateX(0); }
        .theme-toggle-circle.dark { transform: translateX(30px); }
        #schema-container svg { width: 100%; height: auto; }
        .header-bg-light { background-color: rgba(255, 255, 255, 0.8); }
        .dark .header-bg-light { background-color: rgba(31, 41, 55, 0.8); }
        .bg-debate-light { background-color: #ffffff; }
        .dark .bg-debate-light { background-color: #1f2937; }
        .card-bg { background-color: #f3f4f6; }
        .dark .card-bg { background-color: #374151; }
        .message-input-bg { background-color: #f3f4f6; }
        .dark .message-input-bg { background-color: #374151; }
        .ai-message-bg { background-color: #f3f4f6; }
        .dark .ai-message-bg { background-color: #374151; }
        .topic-screen-bg { background-color: #f3f4f6; border-radius: 16px; padding: 24px; }
        .dark .topic-screen-bg { background-color: #1f2937; }
        .select-bg { background-color: #ffffff; border: 1px solid #d1d5db; }
        .dark .select-bg { background-color: #374151; border-color: #4b5563; }
        .custom-topic-bg { background-color: #ffffff; border: 1px solid #d1d5db; }
        .dark .custom-topic-bg { background-color: #374151; border-color: #4b5563; }
        .mic-recording {
            animation: micPulse 1.5s infinite ease-in-out;
        }
        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="text-contrast transition-colors duration-300">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div id="app-container" class="w-full max-w-2xl mx-auto bg-debate-light rounded-2xl shadow-lg flex flex-col" style="height: 90vh; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);">
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between header-bg-light backdrop-blur-sm">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-500">
                        <path d="M12 2a2.5 2.5 0 0 1 2.5 2.5v.75a2.5 2.5 0 0 1-5 0v-.75A2.5 2.5 0 0 1 12 2Z"/><path d="M4.5 9.5A2.5 2.5 0 0 0 7 12v0a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 7 17v0a2.5 2.5 0 0 0-2.5 2.5v0"/><path d="M19.5 9.5A2.5 2.5 0 0 1 17 12v0a2.5 2.5 0 0 1 2.5 2.5v0A2.5 2.5 0 0 1 17 17v0a2.5 2.5 0 0 1 2.5 2.5v0"/><path d="M12 12a2.5 2.5 0 0 0-2.5-2.5v0A2.5 2.5 0 0 0 7 7v0"/><path d="M12 12a2.5 2.5 0 0 1 2.5-2.5v0A2.5 2.5 0 0 1 17 7v0"/><path d="M12 12a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 7 17v0"/><path d="M12 12a2.5 2.5 0 0 1 2.5 2.5v0A2.5 2.5 0 0 1 17 17v0"/><path d="M12 4.75v3.5"/><path d="M7 9.5h10"/><path d="M7 14.5h10"/><path d="M12 17.25v3.5"/>
                    </svg>
                    <div>
                        <h1 data-lang-key="appTitle" class="text-xl font-bold">Münazara Arenası</h1>
                        <p data-lang-key="appSubtitle" class="text-sm text-subtle">Python & Flask Versiyonu</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="user-info" class="hidden items-center space-x-2">
                        <span id="username-display" class="text-sm font-medium"></span>
                        <button data-action="show-history" class="p-2 rounded-full text-subtle hover:bg-gray-200 dark:hover:bg-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m3.9 16.2 5.1-5.1 4 4L18.3 9.8"/></svg></button>
                        <button data-action="logout" class="p-2 rounded-full text-subtle hover:bg-gray-200 dark:hover:bg-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
                    </div>
                    <button data-action="toggle-theme" id="theme-toggle" type="button" class="relative p-1.5 w-[64px] rounded-full bg-gray-200 dark:bg-gray-700 flex items-center transition-colors duration-300 ease-in-out">
                        <span id="toggle-circle" class="theme-toggle-circle w-7 h-7 rounded-full bg-white dark:bg-gray-900 flex items-center justify-center">
                            <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="m4.22 4.22 1.42 1.42"/><path d="m18.36 18.36 1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="m4.22 19.78 1.42-1.42"/><path d="m18.36 5.64 1.42-1.42"/></svg>
                            <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 hidden moon-icon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        </span>
                    </button>
                    <button data-action="toggle-lang" class="text-sm font-semibold text-subtle hover:text-cyan-500">EN</button>
                </div>
            </header>
            
            <main class="flex-grow p-6 overflow-y-auto">
            </main>
        </div>
    </div>
    
    <div id="pdf-render-container" style="position: absolute; top: 0; left: -9999px; background-color: #111827; padding: 20px;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                topic: '',
                stance: '',
                personality: 'standard',
                messages: [],
                lang: 'tr',
                theme: 'light',
                history: [],
                currentReport: null,
                currentSchema: null,
                isRecording: false,
                currentAudio: null,
            };

            const translations = {
                tr: {
                    appTitle: "Münazara Arenası",
                    appSubtitle: "Python & Flask Versiyonu",
                    topicSelectLabel: "1. Bir Münazara Konusu Seçin",
                    topicSelectPlaceholder: "Konu seç...",
                    topic1: "Yapay zeka insanlık için bir tehdit mi?",
                    topic2: "Üniversite eğitimi herkes için ücretsiz mi olmalı?",
                    topic3: "Sosyal medya toplumu olumlu yönde mi etkiliyor?",
                    topicCustom: "Kendi konumu yazmak istiyorum...",
                    customTopicPlaceholder: "Münazara konunuzu buraya yazın",
                    stanceSelectLabel: "2. Tarafınızı Belirleyin",
                    stanceFor: "Savunuyorum",
                    stanceAgainst: "Karşı Çıkıyorum",
                    personalitySelectLabel: "3. Yapay Zeka Kişiliğini Seçin",
                    personalityStandard: "Standart",
                    personalityAcademic: "Akademik",
                    personalityAggressive: "Agresif",
                    personalityCalm: "Sakin",
                    startDebate: "Münazarayı Başlat",
                    topicLabel: "Konu",
                    messagePlaceholder: "Argümanınızı yazın veya mikrofona basın...",
                    endDebate: "Münazarayı Bitir ve Rapor Al",
                    reportTitle: "Performans Raporu",
                    scoreLabel: "İkna Edicilik Puanı",
                    strongestArgument: "En Güçlü Argümanınız",
                    improvementArea: "Geliştirilmesi Gereken Nokta",
                    exampleSentence: "Örnek Cümleniz",
                    suggestion: "Öneri",
                    evidenceUsage: "Kanıt Kullanımı ve Destekleme",
                    generalComment: "Genel Yorum",
                    drawSchema: "Argüman Haritasını Çiz",
                    downloadPDF: "Raporu ve Haritayı İndir",
                    newDebate: "Yeni Münazara Başlat",
                    schemaTitle: "Argüman Haritası",
                    backToReport: "Rapora Geri Dön",
                    pdfLoading: "PDF oluşturuluyor...",
                    errorTopic: "Lütfen bir konu ve taraf seçin.",
                    errorSendMessage: "Mesaj gönderilemedi",
                    errorReport: "Rapor oluşturulamadı",
                    errorSchema: "Şema verisi sunucudan alınamadı.",
                    errorSchemaInvalid: "Yapay zeka geçerli bir şema formatı döndürmedi.",
                    errorSchemaRender: "Argüman haritası çizilirken bir hata oluştu.",
                    errorPDF: "PDF oluşturulurken bir hata oluştu",
                    loginTitle: "Giriş Yap",
                    registerTitle: "Kayıt Ol",
                    usernamePlaceholder: "Kullanıcı Adı",
                    passwordPlaceholder: "Şifre",
                    loginButton: "Giriş Yap",
                    registerButton: "Kayıt Ol",
                    guestButton: "Misafir Olarak Devam Et",
                    showRegister: "Hesabın yok mu? Kayıt ol",
                    showLogin: "Zaten hesabın var mı? Giriş yap",
                    historyTitle: "Münazara Geçmişi",
                    backToMain: "Ana Menüye Dön",
                    analyzeProfile: "Profilimi Analiz Et",
                    profileTitle: "Münazır Profili",
                    profileError: "Profil analizi için en az 3 münazara tamamlamanız gerekmektedir.",
                    progressChart: "Gelişim Grafiği",
                    commonFallacy: "En Sık Tekrarlanan Mantık Hatası",
                    debateStyle: "Münazara Stiliniz",
                    strength: "Güçlü Yönünüz",
                    weakness: "Geliştirilecek Yönünüz"
                },
                en: {
                    appTitle: "Debate Arena",
                    appSubtitle: "Python & Flask Version",
                    topicSelectLabel: "1. Select a Debate Topic",
                    topicSelectPlaceholder: "Select a topic...",
                    topic1: "Is artificial intelligence a threat to humanity?",
                    topic2: "Should university education be free for everyone?",
                    topic3: "Does social media positively affect society?",
                    topicCustom: "I want to write my own topic...",
                    customTopicPlaceholder: "Write your debate topic here",
                    stanceSelectLabel: "2. Choose Your Stance",
                    stanceFor: "I'm For",
                    stanceAgainst: "I'm Against",
                    personalitySelectLabel: "3. Select AI Personality",
                    personalityStandard: "Standard",
                    personalityAcademic: "Academic",
                    personalityAggressive: "Aggressive",
                    personalityCalm: "Calm",
                    startDebate: "Start Debate",
                    topicLabel: "Topic",
                    messagePlaceholder: "Write your argument or press the mic...",
                    endDebate: "End Debate & Get Report",
                    reportTitle: "Performance Report",
                    scoreLabel: "Persuasiveness Score",
                    strongestArgument: "Your Strongest Argument",
                    improvementArea: "Area for Improvement",
                    exampleSentence: "Your Example Sentence",
                    suggestion: "Suggestion",
                    evidenceUsage: "Use of Evidence and Support",
                    generalComment: "General Feedback",
                    drawSchema: "Draw Argument Map",
                    downloadPDF: "Download Report & Map",
                    newDebate: "Start New Debate",
                    schemaTitle: "Argument Map",
                    backToReport: "Back to Report",
                    pdfLoading: "Generating PDF...",
                    errorTopic: "Please select a topic and a stance.",
                    errorSendMessage: "Could not send message",
                    errorReport: "Could not generate report",
                    errorSchema: "Could not fetch schema data from server.",
                    errorSchemaInvalid: "AI did not return a valid schema format.",
                    errorSchemaRender: "An error occurred while drawing the argument map.",
                    errorPDF: "An error occurred while generating the PDF",
                    loginTitle: "Login",
                    registerTitle: "Register",
                    usernamePlaceholder: "Username",
                    passwordPlaceholder: "Password",
                    loginButton: "Login",
                    registerButton: "Register",
                    guestButton: "Continue as Guest",
                    showRegister: "Don't have an account? Register",
                    showLogin: "Already have an account? Login",
                    historyTitle: "Debate History",
                    backToMain: "Back to Main Menu",
                    analyzeProfile: "Analyze My Profile",
                    profileTitle: "Debater Profile",
                    profileError: "You need to complete at least 3 debates for a profile analysis.",
                    progressChart: "Progress Chart",
                    commonFallacy: "Most Common Logical Fallacy",
                    debateStyle: "Your Debate Style",
                    strength: "Your Strength",
                    weakness: "Area to Improve"
                }
            };
            
            const mainContent = document.querySelector('main');
            
            function setLanguage(lang) {
                state.lang = lang;
                localStorage.setItem('lang', lang);
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                            if (el.placeholder) el.placeholder = translation;
                        } else {
                            el.textContent = translation;
                        }
                    }
                });
                const langToggler = document.querySelector('[data-action="toggle-lang"]');
                if(langToggler) langToggler.textContent = lang === 'tr' ? 'EN' : 'TR';
            }

            function setTheme(theme) {
                state.theme = theme;
                localStorage.setItem('theme', theme);
                const toggleCircle = document.getElementById('toggle-circle');
                const lightIcon = document.getElementById('theme-icon-light');
                const darkIcon = document.getElementById('theme-icon-dark');

                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    if(toggleCircle) toggleCircle.classList.add('dark');
                    if(toggleCircle) toggleCircle.classList.remove('light');
                    if(lightIcon) lightIcon.classList.add('hidden');
                    if(darkIcon) darkIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    if(toggleCircle) toggleCircle.classList.add('light');
                    if(toggleCircle) toggleCircle.classList.remove('dark');
                    if(lightIcon) lightIcon.classList.remove('hidden');
                    if(darkIcon) darkIcon.classList.add('hidden');
                }
                mermaid.initialize({ startOnLoad: false, theme: state.theme });
            }

            function showScreen(htmlContent) {
                mainContent.innerHTML = htmlContent;
                setLanguage(state.lang);
            }

            function updateMessages() {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;
                messagesContainer.innerHTML = state.messages.map((msg, index) => `
                    <div class="flex items-start gap-3 animate-fade-in ${msg.author === 'user' ? 'justify-end' : 'justify-start'}">
                        ${msg.author === 'ai' ? `
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-500"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            </div>` : ''}
                        <div class="max-w-md p-3 rounded-xl ${msg.author === 'user' ? 'bg-cyan-600 text-white rounded-br-none' : 'ai-message-bg text-contrast rounded-bl-none'}">
                            <p class="text-sm" style="white-space: pre-wrap;">${msg.text}</p>
                        </div>
                        ${msg.author === 'ai' ? `
                            <button data-action="generate-and-play-audio" data-message-index="${index}" class="p-2 rounded-full text-subtle self-center hover:bg-gray-200 dark:hover:bg-gray-600">
                                <svg class="speaker-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                                <div class="spinner hidden"></div>
                            </button>
                        ` : ''}
                        ${msg.author === 'user' ? '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-300"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>' : ''}
                    </div>
                `).join('');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function addMessage(author, text) {
                state.messages.push({ author, text, audio: null });
                updateMessages();
            }

            function setLoading(isLoading, message = '') {
                document.querySelectorAll('[data-action]').forEach(el => el.disabled = isLoading);
                const messageInput = document.getElementById('message-input');
                if(messageInput) messageInput.disabled = isLoading;

                const messagesContainer = document.getElementById('messages-container');
                let loadingEl = document.getElementById('loading-indicator');
                if (isLoading) {
                    if (!loadingEl && messagesContainer) {
                        loadingEl = document.createElement('div');
                        loadingEl.id = 'loading-indicator';
                        loadingEl.innerHTML = `
                            <div class="flex items-start gap-3 justify-start">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-500"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>
                                <div class="max-w-md p-3 rounded-xl ai-message-bg text-contrast rounded-bl-none">
                                    <div class="flex items-center space-x-2"><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div></div>
                                    ${message ? `<p class="text-sm ml-2">${message}</p>` : ''}
                                </div>
                            </div>`;
                        messagesContainer.appendChild(loadingEl);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else {
                    if (loadingEl) loadingEl.remove();
                }
            }

            function renderLoginScreen() {
                const html = `
                    <div id="login-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-4">
                            <h2 data-lang-key="loginTitle" class="text-2xl font-bold text-center">Giriş Yap</h2>
                            <input id="login-username" type="text" data-lang-key="usernamePlaceholder" placeholder="Kullanıcı Adı" class="w-full p-3 custom-topic-bg rounded-lg text-contrast">
                            <input id="login-password" type="password" data-lang-key="passwordPlaceholder" placeholder="Şifre" class="w-full p-3 custom-topic-bg rounded-lg text-contrast">
                            <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                            <button data-action="login" class="w-full p-3 bg-cyan-600 text-white font-bold rounded-lg"><span data-lang-key="loginButton">Giriş Yap</span></button>
                            <button data-action="guest-login" class="w-full p-3 bg-gray-500 text-white font-bold rounded-lg"><span data-lang-key="guestButton">Misafir Olarak Devam Et</span></button>
                            <p class="text-center text-sm"><button data-action="show-register" class="text-cyan-500 hover:underline"><span data-lang-key="showRegister">Hesabın yok mu? Kayıt ol</span></button></p>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderRegisterScreen() {
                const html = `
                    <div id="register-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-4">
                            <h2 data-lang-key="registerTitle" class="text-2xl font-bold text-center">Kayıt Ol</h2>
                            <input id="register-username" type="text" data-lang-key="usernamePlaceholder" placeholder="Kullanıcı Adı" class="w-full p-3 custom-topic-bg rounded-lg text-contrast">
                            <input id="register-password" type="password" data-lang-key="passwordPlaceholder" placeholder="Şifre" class="w-full p-3 custom-topic-bg rounded-lg text-contrast">
                            <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                            <button data-action="register" class="w-full p-3 bg-cyan-600 text-white font-bold rounded-lg"><span data-lang-key="registerButton">Kayıt Ol</span></button>
                            <p class="text-center text-sm"><button data-action="show-login" class="text-cyan-500 hover:underline"><span data-lang-key="showLogin">Zaten hesabın var mı? Giriş yap</span></button></p>
                        </div>
                    </div>
                `;
                showScreen(html);
            }
            
            function checkCanStart() {
                const topicSelect = document.getElementById('topic-select');
                const customTopicInput = document.getElementById('custom-topic-input');
                const startBtn = document.getElementById('start-debate-btn');
                const errorMessage = document.getElementById('error-message');
                
                if (!topicSelect || !startBtn) return;

                const isCustomTopic = topicSelect.value === 'custom';
                const customTopicValid = !isCustomTopic || (customTopicInput && customTopicInput.value.trim().length > 0);
                
                const canStart = state.stance && state.topic && customTopicValid;
                startBtn.disabled = !canStart;
                
                if (errorMessage) {
                    errorMessage.textContent = canStart ? '' : translations[state.lang].errorTopic;
                }
            }
            
            function renderTopicScreen() {
                const html = `
                    <div id="topic-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-6">
                            <div>
                                <label for="topic-select" data-lang-key="topicSelectLabel" class="block text-sm font-medium text-subtle mb-2">1. Bir Münazara Konusu Seçin</label>
                                <select id="topic-select" class="w-full p-3 select-bg rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast">
                                    <option value="" disabled selected data-lang-key="topicSelectPlaceholder">Konu seç...</option>
                                    <option value="Yapay zeka insanlık için bir tehdit mi?" data-lang-key="topic1">Yapay zeka insanlık için bir tehdit mi?</option>
                                    <option value="Üniversite eğitimi herkes için ücretsiz mi olmalı?" data-lang-key="topic2">Üniversite eğitimi herkes için ücretsiz mi olmalı?</option>
                                    <option value="Sosyal medya toplumu olumlu yönde mi etkiliyor?" data-lang-key="topic3">Sosyal medya toplumu olumlu yönde mi etkiliyor?</option>
                                    <option value="custom" data-lang-key="topicCustom">Kendi konumu yazmak istiyorum...</option>
                                </select>
                            </div>
                            <div id="custom-topic-container" class="hidden">
                                <input type="text" id="custom-topic-input" data-lang-key="customTopicPlaceholder" placeholder="Münazara konunuzu buraya yazın" class="w-full p-3 custom-topic-bg rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast" />
                            </div>
                            <div>
                                <h3 data-lang-key="stanceSelectLabel" class="block text-sm font-medium text-subtle mb-2">2. Tarafınızı Belirleyin</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <button data-action="set-stance" data-stance="savunuyorum" class="p-4 rounded-lg text-center transition card-bg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium">
                                        <span data-lang-key="stanceFor">Savunuyorum</span>
                                    </button>
                                    <button data-action="set-stance" data-stance="karşı çıkıyorum" class="p-4 rounded-lg text-center transition card-bg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium">
                                        <span data-lang-key="stanceAgainst">Karşı Çıkıyorum</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="personality-select" data-lang-key="personalitySelectLabel" class="block text-sm font-medium text-subtle mb-2">3. Yapay Zeka Kişiliğini Seçin</label>
                                <select id="personality-select" class="w-full p-3 select-bg rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast">
                                    <option value="standard" selected data-lang-key="personalityStandard">Standart</option>
                                    <option value="academic" data-lang-key="personalityAcademic">Akademik</option>
                                    <option value="aggressive" data-lang-key="personalityAggressive">Agresif</option>
                                    <option value="calm" data-lang-key="personalityCalm">Sakin</option>
                                </select>
                            </div>
                            <p id="error-message" class="text-red-500 dark:text-red-400 text-sm text-center h-4"></p>
                            <button data-action="start-debate" id="start-debate-btn" class="w-full p-4 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-bold text-white text-lg transition disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed shadow-md hover:shadow-lg" disabled>
                                <span data-lang-key="startDebate">Münazarayı Başlat</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                const topicSelect = document.getElementById('topic-select');
                const customTopicInput = document.getElementById('custom-topic-input');
                const personalitySelect = document.getElementById('personality-select');
                
                topicSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('custom-topic-container').classList.remove('hidden');
                        customTopicInput.focus();
                        state.topic = customTopicInput.value.trim();
                    } else {
                        document.getElementById('custom-topic-container').classList.add('hidden');
                        state.topic = this.value;
                    }
                    checkCanStart();
                });
                
                if (customTopicInput) {
                    customTopicInput.addEventListener('input', function() {
                        state.topic = this.value;
                        checkCanStart();
                    });
                }
                
                personalitySelect.addEventListener('change', function() {
                    state.personality = this.value;
                });
                
                state.topic = topicSelect.value === 'custom' ? '' : topicSelect.value;
                checkCanStart();
            }

            function renderDebateScreen() {
                const html = `
                    <div id="debate-screen" class="flex flex-col h-full">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 header-bg-light backdrop-blur-sm -mx-6 -mt-6 mb-4 sticky top-0 z-10">
                            <h3 id="debate-topic-header" class="text-center font-semibold text-subtle"><span data-lang-key="topicLabel">Konu</span>: <span class="text-cyan-600 dark:text-cyan-400">${state.topic}</span></h3>
                        </div>
                        <div id="messages-container" class="flex-grow overflow-y-auto pr-4 -mr-4 space-y-6">
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center space-x-2">
                                <input type="text" id="message-input" data-lang-key="messagePlaceholder" placeholder="Argümanınızı yazın veya mikrofona basın..." class="flex-grow p-3 message-input-bg border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast" />
                                <button data-action="toggle-mic" id="mic-btn" class="p-3 bg-gray-500 hover:bg-gray-600 rounded-lg transition shadow">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg>
                                </button>
                                <button data-action="send-message" id="send-btn" class="p-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg transition disabled:bg-gray-500 dark:disabled:bg-gray-600 shadow">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                                </button>
                            </div>
                            <button data-action="end-debate" id="end-debate-btn" class="w-full mt-3 p-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition disabled:bg-gray-500 dark:disabled:bg-gray-600 shadow-md hover:shadow-lg">
                                <span data-lang-key="endDebate">Münazarayı Bitir ve Rapor Al</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                updateMessages();
                
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.querySelector('[data-action="send-message"]').click();
                        }
                    });
                }
            }
            
            function renderReportScreen(report) {
                state.currentReport = report;
                const score = report.iknaEdicilikPuani || 0;
                const html = `
                    <div id="report-screen-content" class="flex flex-col h-full animate-fade-in">
                        <div id="report-content" class="space-y-6 pt-4">
                            <h2 data-lang-key="reportTitle" class="text-3xl font-bold text-center text-cyan-600 dark:text-cyan-400">Performans Raporu</h2>
                            <div class="relative flex justify-center items-center">
                                <svg class="transform -rotate-90" width="120" height="120" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="currentColor" class="text-gray-200 dark:text-gray-700" stroke-width="12" />
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="currentColor" class="text-cyan-500" stroke-width="12" pathLength="1" stroke-dasharray="1" stroke-dashoffset="${1 - (score / 10)}" />
                                </svg>
                                <span class="absolute text-3xl font-bold">${score}<span class="text-lg">/10</span></span>
                            </div>
                            <p data-lang-key="scoreLabel" class="text-center text-lg font-semibold text-subtle">İkna Edicilik Puanı</p>
                            <div class="space-y-4">
                                <div class="p-4 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                    <h3 data-lang-key="strongestArgument" class="font-semibold text-green-600 dark:text-green-400 mb-2">En Güçlü Argümanınız</h3>
                                    <p class="text-sm">${report.enGucluArguman || '...'}</p>
                                </div>
                                <div class="p-4 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                    <h3 class="font-semibold text-yellow-600 dark:text-yellow-400 mb-2"><span data-lang-key="improvementArea">Geliştirilmesi Gereken Nokta</span>: ${report.gelistirilmesiGerekenNokta?.tespitEdilenHataTuru || 'Genel'}</h3>
                                    <p class="text-sm text-subtle mt-1 mb-2"><em>${report.gelistirilmesiGerekenNokta?.hataTanimi || ''}</em></p>
                                    <p class="text-sm border-l-4 border-yellow-500 dark:border-yellow-400 pl-3"><strong><span data-lang-key="exampleSentence">Örnek Cümleniz</span>:</strong> "${report.gelistirilmesiGerekenNokta?.ornekCumle || '...'}"</p>
                                    <p class="text-sm mt-2"><strong><span data-lang-key="suggestion">Öneri</span>:</strong> ${report.gelistirilmesiGerekenNokta?.onerilenGelistirme || '...'}</p>
                                </div>
                                <div class="p-4 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                    <h3 data-lang-key="evidenceUsage" class="font-semibold text-indigo-600 dark:text-indigo-400 mb-2">Kanıt Kullanımı ve Destekleme</h3>
                                    <p class="text-sm">${report.kanitKullanimi || '...'}</p>
                                </div>
                                <div class="p-4 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                    <h3 data-lang-key="generalComment" class="font-semibold text-cyan-600 dark:text-cyan-400 mb-2">Genel Yorum</h3>
                                    <p class="text-sm">${report.genelYorum || '...'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 space-y-3">
                            <button data-action="draw-schema" class="w-full p-3 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-bold transition shadow-md hover:shadow-lg"><span data-lang-key="drawSchema">Argüman Haritasını Çiz</span></button>
                            <button data-action="download-pdf" class="w-full p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition shadow-md hover:shadow-lg"><span data-lang-key="downloadPDF">Raporu ve Haritayı İndir</span></button>
                            <button data-action="new-debate" class="w-full p-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-bold transition shadow-md hover:shadow-lg"><span data-lang-key="newDebate">Yeni Münazara Başlat</span></button>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderSchemaScreen(schemaData) {
                state.currentSchema = schemaData;
                const html = `
                    <div id="schema-screen" class="flex flex-col h-full">
                        <h2 data-lang-key="schemaTitle" class="text-2xl font-bold text-center text-cyan-600 dark:text-cyan-400 mb-4">Argüman Haritası</h2>
                        <div id="schema-container" class="flex-grow bg-white dark:bg-gray-900 p-4 rounded-lg overflow-auto">
                        </div>
                        <div class="mt-4">
                            <button data-action="back-to-report" class="w-full p-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-bold transition shadow-md hover:shadow-lg">
                                <span data-lang-key="backToReport">Rapora Geri Dön</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                const schemaContainer = document.getElementById('schema-container');
                try {
                    if (schemaData && schemaData.schema) {
                        mermaid.render('mermaid-graph', schemaData.schema, (svg) => {
                            schemaContainer.innerHTML = svg;
                        });
                    } else {
                        throw new Error(translations[state.lang].errorSchemaInvalid);
                    }
                } catch (error) {
                    console.error("Mermaid render error:", error);
                    schemaContainer.innerHTML = `<p class="text-red-500">${translations[state.lang].errorSchemaRender}</p><p class="text-xs text-subtle mt-2">${error.message}</p>`;
                }
            }

            function renderHistoryScreen(history) {
                const historyItems = history.map(item => `
                    <div data-action="view-history-item" data-id="${item.id}" class="p-4 card-bg rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <p class="font-semibold text-contrast">${item.topic}</p>
                        <p class="text-sm text-subtle">${item.timestamp}</p>
                    </div>
                `).join('');

                const html = `
                    <div id="history-screen" class="flex flex-col h-full animate-fade-in">
                        <h2 data-lang-key="historyTitle" class="text-2xl font-bold text-center mb-4">Münazara Geçmişi</h2>
                        <div class="flex-grow space-y-3 overflow-y-auto">
                            ${history.length > 0 ? historyItems : `<p class="text-center text-subtle">Henüz bir münazara tamamlamadınız.</p>`}
                        </div>
                        <div class="mt-4 space-y-3">
                            <button data-action="analyze-profile" class="w-full p-3 bg-teal-600 text-white font-bold rounded-lg disabled:bg-gray-500" ${history.length < 3 ? 'disabled' : ''}><span data-lang-key="analyzeProfile">Profilimi Analiz Et</span></button>
                            <button data-action="back-to-main" class="w-full p-3 bg-cyan-600 text-white font-bold rounded-lg"><span data-lang-key="backToMain">Ana Menüye Dön</span></button>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderProfileScreen(profile) {
                const html = `
                    <div id="profile-screen" class="flex flex-col h-full animate-fade-in">
                        <h2 data-lang-key="profileTitle" class="text-2xl font-bold text-center mb-4">Münazır Profili</h2>
                        <div class="flex-grow space-y-4 overflow-y-auto p-1">
                            <div class="p-4 card-bg rounded-lg">
                                <h3 data-lang-key="progressChart" class="font-semibold text-contrast mb-2">Gelişim Grafiği</h3>
                                <canvas id="progressChart"></canvas>
                            </div>
                            <div class="p-4 card-bg rounded-lg">
                                <h3 data-lang-key="commonFallacy" class="font-semibold text-contrast mb-2">En Sık Tekrarlanan Mantık Hatası</h3>
                                <p class="font-bold text-yellow-500">${profile.enSikHata?.hataTuru || 'Belirlenmedi'}</p>
                                <p class="text-sm text-subtle mt-1">${profile.enSikHata?.tavsiye || 'Tavsiye bulunamadı.'}</p>
                            </div>
                            <div class="p-4 card-bg rounded-lg">
                                <h3 data-lang-key="debateStyle" class="font-semibold text-contrast mb-2">Münazara Stiliniz</h3>
                                <p class="text-sm">${profile.munazaraStili || 'Analiz ediliyor...'}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 card-bg rounded-lg">
                                    <h3 data-lang-key="strength" class="font-semibold text-green-500 mb-2">Güçlü Yönünüz</h3>
                                    <p class="text-sm">${profile.gucluYon || 'Analiz ediliyor...'}</p>
                                </div>
                                <div class="p-4 card-bg rounded-lg">
                                    <h3 data-lang-key="weakness" class="font-semibold text-red-500 mb-2">Geliştirilecek Yönünüz</h3>
                                    <p class="text-sm">${profile.gelistirilecekYon || 'Analiz ediliyor...'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button data-action="show-history" class="w-full p-3 bg-cyan-600 text-white font-bold rounded-lg">Geri Dön</button>
                        </div>
                    </div>
                `;
                showScreen(html);
                
                const ctx = document.getElementById('progressChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: state.history.map((_, i) => `Münazara ${i + 1}`),
                        datasets: [{
                            label: 'İkna Puanı',
                            data: state.history.map(d => d.report.iknaEdicilikPuani),
                            borderColor: '#06b6d4',
                            tension: 0.1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 10 } } }
                });
            }
            
            async function handleAction(event) {
                const target = event.target.closest('[data-action]');
                if (!target || target.disabled) return;

                const action = target.dataset.action;

                if (action === 'toggle-theme') {
                    setTheme(state.theme === 'dark' ? 'light' : 'dark');
                }

                if (action === 'toggle-lang') {
                    setLanguage(state.lang === 'tr' ? 'en' : 'tr');
                }
                
                if (action === 'toggle-mic') {
                    toggleRecording();
                }
                
                if (action === 'generate-and-play-audio') {
                    const messageIndex = parseInt(target.dataset.messageIndex);
                    const message = state.messages[messageIndex];
                    const speakerIcon = target.querySelector('.speaker-icon');
                    const spinner = target.querySelector('.spinner');

                    if (state.currentAudio) {
                        state.currentAudio.pause();
                        if (state.currentAudio.messageIndex === messageIndex) {
                            state.currentAudio = null;
                            return;
                        }
                    }

                    if (message.audio) {
                        playPcmAudio(message.audio.audioData, message.audio.mimeType, messageIndex);
                    } else {
                        speakerIcon.classList.add('hidden');
                        spinner.classList.remove('hidden');
                        target.disabled = true;

                        try {
                            const response = await fetch('/api/tts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: message.text })
                            });
                            if (!response.ok) throw new Error('TTS request failed');
                            const data = await response.json();
                            message.audio = data;
                            playPcmAudio(data.audioData, data.mimeType, messageIndex);
                        } catch (error) {
                            console.error("Error fetching TTS data:", error);
                        } finally {
                            speakerIcon.classList.remove('hidden');
                            spinner.classList.add('hidden');
                            target.disabled = false;
                        }
                    }
                }

                if (action === 'set-stance') {
                    state.stance = target.dataset.stance;
                    
                    document.querySelectorAll('[data-action="set-stance"]').forEach(btn => {
                        btn.classList.remove('bg-green-500', 'dark:bg-green-600', 'ring-2', 'ring-green-400', 'text-white');
                        btn.classList.remove('bg-red-500', 'dark:bg-red-600', 'ring-red-400');
                        btn.classList.add('card-bg', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                    });
                    
                    target.classList.remove('card-bg', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                    target.classList.add(
                        state.stance === 'savunuyorum' ? 'bg-green-500' : 'bg-red-500',
                        state.stance === 'savunuyorum' ? 'dark:bg-green-600' : 'dark:bg-red-600',
                        'ring-2',
                        state.stance === 'savunuyorum' ? 'ring-green-400' : 'ring-red-400',
                        'text-white'
                    );
                    
                    checkCanStart();
                }

                if (action === 'start-debate') {
                    const topicSelect = document.getElementById('topic-select');
                    const customTopicInput = document.getElementById('custom-topic-input');
                    const finalTopic = topicSelect.value === 'custom' ? customTopicInput.value.trim() : topicSelect.value;
                    if (!finalTopic || !state.stance) {
                        checkCanStart();
                        return;
                    }
                    state.topic = finalTopic;
                    state.messages = [];
                    renderDebateScreen();
                }

                if (action === 'send-message') {
                    const messageInput = document.getElementById('message-input');
                    const text = messageInput.value.trim();
                    if (!text) return;
                    
                    addMessage('user', text);
                    messageInput.value = '';
                    setLoading(true);
                    
                    try {
                        const response = await fetch('/api/debate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                topic: state.topic,
                                stance: state.stance,
                                personality: state.personality,
                                messages: state.messages,
                                lang: state.lang
                            })
                        });
                        
                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({error: translations[state.lang].errorSendMessage}));
                            throw new Error(errData.error || translations[state.lang].errorSendMessage);
                        }
                        
                        const data = await response.json();
                        addMessage('ai', data.reply);
                        
                    } catch (error) {
                        addMessage('ai', `${translations[state.lang].errorSendMessage}: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'end-debate') {
                    setLoading(true);
                    try {
                        const response = await fetch('/api/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                messages: state.messages,
                                topic: state.topic,
                                lang: state.lang
                            })
                        });
                        if (!response.ok) {
                             const errData = await response.json().catch(() => ({error: translations[state.lang].errorReport}));
                             throw new Error(errData.error || translations[state.lang].errorReport);
                        }
                        const report = await response.json();
                        renderReportScreen(report);
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'new-debate' || action === 'back-to-main') {
                    renderTopicScreen();
                }
                
                if (action === 'back-to-report') {
                    renderReportScreen(state.currentReport);
                }

                if (action === 'draw-schema') {
                    setLoading(true);
                     try {
                        const response = await fetch('/api/schema', {
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify({
                               messages: state.messages,
                               lang: state.lang
                           })
                        });
                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({error: translations[state.lang].errorSchema}));
                            throw new Error(errData.error || translations[state.lang].errorSchema);
                        }
                        const schemaData = await response.json();
                        renderSchemaScreen(schemaData);
                    } catch (error) {
                        console.error("Schema error:", error);
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'download-pdf') {
                    setLoading(true, translations[state.lang].pdfLoading);
                    try {
                        if (!state.currentReport) {
                             alert("PDF oluşturmak için önce bir rapor oluşturulmalıdır.");
                             setLoading(false);
                             return;
                        }

                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const reportElement = document.getElementById('report-content');
                        
                        const reportCanvas = await html2canvas(reportElement, { scale: 2, useCORS: true, backgroundColor: state.theme === 'dark' ? '#1f2937' : '#ffffff' });
                        const reportImgData = reportCanvas.toDataURL('image/png');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (reportCanvas.height * pdfWidth) / reportCanvas.width;
                        pdf.addImage(reportImgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        
                        if (state.currentSchema && state.currentSchema.schema) {
                            pdf.addPage();
                            const schemaContainer = document.createElement('div');
                            schemaContainer.style.width = '800px'; 
                            document.body.appendChild(schemaContainer);
                            
                            const svgText = await mermaid.render('pdf-mermaid', state.currentSchema.schema);
                            schemaContainer.innerHTML = svgText.svg;
                            const schemaCanvas = await html2canvas(schemaContainer, { scale: 2, useCORS: true });
                            const schemaImgData = schemaCanvas.toDataURL('image/png');
                            const schemaPdfHeight = (schemaCanvas.height * pdfWidth) / schemaCanvas.width;
                            pdf.addImage(schemaImgData, 'PNG', 0, 0, pdfWidth, schemaPdfHeight);
                            document.body.removeChild(schemaContainer);
                        }
                        
                        pdf.save('munazara-raporu.pdf');

                    } catch (error) {
                        console.error("PDF Oluşturma Hatası:", error);
                        alert(`${translations[state.lang].errorPDF}: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                }
                
                if (action === 'show-register') {
                    renderRegisterScreen();
                }

                if (action === 'show-login') {
                    renderLoginScreen();
                }
                
                if (action === 'guest-login') {
                    document.getElementById('user-info').classList.add('hidden');
                    renderTopicScreen();
                }

                if (action === 'login' || action === 'register') {
                    const isLogin = action === 'login';
                    const endpoint = isLogin ? '/api/login' : '/api/register';
                    const usernameEl = document.getElementById(isLogin ? 'login-username' : 'register-username');
                    const passwordEl = document.getElementById(isLogin ? 'login-password' : 'register-password');
                    const errorEl = document.getElementById('auth-error');
                    
                    const username = usernameEl.value;
                    const password = passwordEl.value;

                    if (!username || !password) {
                        errorEl.textContent = "Kullanıcı adı ve şifre gereklidir.";
                        return;
                    }

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password })
                        });
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Bir hata oluştu.');
                        }
                        
                        if (isLogin) {
                            document.getElementById('user-info').classList.remove('hidden');
                            document.getElementById('username-display').textContent = data.username;
                            renderTopicScreen();
                        } else {
                            alert('Kayıt başarılı! Lütfen giriş yapın.');
                            renderLoginScreen();
                        }

                    } catch (error) {
                        errorEl.textContent = error.message;
                    }
                }

                if (action === 'logout') {
                    await fetch('/api/logout', { method: 'POST' });
                    document.getElementById('user-info').classList.add('hidden');
                    renderLoginScreen();
                }

                if (action === 'show-history') {
                    try {
                        const response = await fetch('/api/history');
                        if (!response.ok) {
                            const data = await response.json().catch(() => null);
                            alert(data?.error || 'Geçmiş verileri alınamadı.');
                            if (response.status === 401) {
                                renderLoginScreen();
                            }
                            return;
                        }
                        const historyData = await response.json();
                        state.history = historyData;
                        renderHistoryScreen(historyData);
                    } catch (error) {
                        console.error('History fetch error:', error);
                    }
                }

                if (action === 'view-history-item') {
                    const debateId = parseInt(target.dataset.id);
                    const debate = state.history.find(d => d.id === debateId);
                    if (debate) {
                        renderReportScreen(debate.report);
                        state.currentSchema = debate.schema;
                    }
                }

                if(action === 'analyze-profile') {
                    setLoading(true);
                    try {
                        const response = await fetch(`/api/profile?lang=${state.lang}`);
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || "Profil analizi yapılamadı.");
                        }
                        renderProfileScreen(data);
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = state.lang;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onresult = (event) => {
                    const text = event.results[event.results.length - 1][0].transcript.trim();
                    document.getElementById('message-input').value = text;
                    document.getElementById('send-btn').click();
                };
                
                recognition.onspeechend = () => {
                    toggleRecording(false);
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    toggleRecording(false);
                };
            }

            function toggleRecording(force) {
                const micBtn = document.getElementById('mic-btn');
                if (!micBtn) return;
                
                state.isRecording = force !== undefined ? force : !state.isRecording;

                if (state.isRecording) {
                    recognition.lang = state.lang;
                    recognition.start();
                    micBtn.classList.add('bg-red-600', 'mic-recording');
                    micBtn.classList.remove('bg-gray-500');
                } else {
                    recognition.stop();
                    micBtn.classList.remove('bg-red-600', 'mic-recording');
                    micBtn.classList.add('bg-gray-500');
                }
            }
            
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                const numChannels = 1;
                const bitsPerSample = 16;
                const blockAlign = numChannels * bitsPerSample / 8;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT;

                view.setUint32(0, 0x52494646, false);
                view.setUint32(4, 36 + dataSize, true);
                view.setUint32(8, 0x57415645, false);
                view.setUint32(12, 0x666d7420, false);
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitsPerSample, true);
                view.setUint32(36, 0x64617461, false);
                view.setUint32(40, dataSize, true);

                const wavBlob = new Blob([view, pcmData], { type: 'audio/wav' });
                return wavBlob;
            }

            function playPcmAudio(audioData, mimeType, messageIndex) {
                try {
                    if (state.currentAudio) {
                        state.currentAudio.pause();
                    }
                    
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) {
                        console.error('Sample rate not found in mimeType:', mimeType);
                        return;
                    }
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    state.currentAudio = new Audio(audioUrl);
                    state.currentAudio.messageIndex = messageIndex;
                    state.currentAudio.play();

                } catch (error) {
                    console.error("Error playing PCM audio:", error);
                }
            }
            
            async function initApp() {
                const savedLang = localStorage.getItem('lang') || 'tr';
                const savedTheme = localStorage.getItem('theme') || 'light';
                
                setLanguage(savedLang);
                setTheme(savedTheme);
                mermaid.initialize({ startOnLoad: false, theme: savedTheme });
                document.body.addEventListener('click', handleAction);

                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    if (data.logged_in) {
                        document.getElementById('user-info').classList.remove('hidden');
                        document.getElementById('username-display').textContent = data.username;
                        renderTopicScreen();
                    } else {
                        renderLoginScreen();
                    }
                } catch (error) {
                    console.error("Could not check status:", error);
                    renderLoginScreen();
                }
            }

            initApp();
        });
    </script>
</body>
</html>
