<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Münazara Arenası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }

        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .dark body { background-color: #111827; }
        .text-contrast { color: #1f2937; }
        .dark .text-contrast { color: #f9fafb; }
        .text-subtle { color: #4b5563; }
        .dark .text-subtle { color: #9ca3af; }

        /* Enhanced button styles with better contrast */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border: 2px solid #0284c7;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #9ca3af;
            border-color: #9ca3af;
            box-shadow: none;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border: 2px solid #4f46e5;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 2px solid #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }

        /* Voice recording styles */
        .recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1s infinite;
        }

        /* Navigation bar */
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        }
        .dark .nav-bar {
            background: rgba(31, 41, 55, 0.95);
            border-bottom-color: rgba(75, 85, 99, 0.8);
        }

        /* Theme toggle improvements */
        .theme-toggle {
            background: #e5e7eb;
            transition: all 0.3s ease;
        }
        .dark .theme-toggle {
            background: #374151;
        }
        .theme-toggle-circle {
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dark .theme-toggle-circle {
            background: #1f2937;
            transform: translateX(28px);
        }

        #schema-container svg { width: 100%; height: auto; }
        .bg-debate-light { background-color: #ffffff; }
        .dark .bg-debate-light { background-color: #1f2937; }
        .card-bg { background-color: #f3f4f6; }
        .dark .card-bg { background-color: #374151; }
        .message-input-bg { background-color: #ffffff; border: 2px solid #e5e7eb; }
        .dark .message-input-bg { background-color: #374151; border-color: #4b5563; }
        .ai-message-bg { background-color: #f3f4f6; }
        .dark .ai-message-bg { background-color: #374151; }
        .topic-screen-bg {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
        }
        .dark .topic-screen-bg {
            background-color: #1f2937;
            border-color: #374151;
        }
        .select-bg {
            background-color: #ffffff;
            border: 2px solid #d1d5db;
        }
        .dark .select-bg {
            background-color: #374151;
            border-color: #4b5563;
        }
        .custom-topic-bg {
            background-color: #ffffff;
            border: 2px solid #d1d5db;
        }
        .dark .custom-topic-bg {
            background-color: #374151;
            border-color: #4b5563;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="text-contrast transition-colors duration-300">

    <!-- Navigation Bar -->
    <nav class="nav-bar fixed top-0 left-0 right-0 z-50 animate-slide-down">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-500">
                        <path d="M12 2a2.5 2.5 0 0 1 2.5 2.5v.75a2.5 2.5 0 0 1-5 0v-.75A2.5 2.5 0 0 1 12 2Z"/>
                        <path d="M4.5 9.5A2.5 2.5 0 0 0 7 12v0a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 7 17v0a2.5 2.5 0 0 0-2.5 2.5v0"/>
                        <path d="M19.5 9.5A2.5 2.5 0 0 1 17 12v0a2.5 2.5 0 0 1 2.5 2.5v0A2.5 2.5 0 0 1 17 17v0a2.5 2.5 0 0 1 2.5 2.5v0"/>
                    </svg>
                    <h1 class="text-xl font-bold">Münazara Arenası</h1>
                </div>

                <div class="flex items-center space-x-4">
                    <a href="/" class="px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        Münazara
                    </a>
                    <a href="/ogrenme-yollari" class="px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        Öğrenme Yolları
                    </a>

                    <div id="user-info" class="hidden items-center space-x-3">
                        <span id="username-display" class="text-sm font-medium"></span>
                        <button data-action="show-history" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/><path d="m3.9 16.2 5.1-5.1 4 4L18.3 9.8"/>
                            </svg>
                        </button>
                        <button data-action="logout" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" x2="9" y1="12" y2="12"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="theme-toggle relative w-14 h-7 rounded-full p-1 transition-colors duration-300">
                        <div class="theme-toggle-circle w-5 h-5 rounded-full flex items-center justify-center">
                            <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-500">
                                <circle cx="12" cy="12" r="5"/>
                                <path d="M12 1v2"/><path d="M12 21v2"/>
                                <path d="m4.22 4.22 1.42 1.42"/><path d="m18.36 18.36 1.42 1.42"/>
                                <path d="M1 12h2"/><path d="M21 12h2"/>
                                <path d="m4.22 19.78 1.42-1.42"/><path d="m18.36 5.64 1.42-1.42"/>
                            </svg>
                            <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-400 hidden">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </div>
                    </button>

                    <button data-action="toggle-lang" class="text-sm font-semibold px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">EN</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="min-h-screen pt-16 flex flex-col items-center justify-center p-4">
        <div id="app-container" class="w-full max-w-2xl mx-auto bg-debate-light rounded-2xl shadow-xl flex flex-col" style="height: 85vh; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);">
            <main class="flex-grow p-6 overflow-y-auto">
                <!-- Content will be loaded here -->
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                topic: '',
                stance: '',
                messages: [],
                lang: 'tr',
                theme: localStorage.getItem('theme') || 'light',
                history: [],
                currentReport: null,
                currentSchema: null,
                isRecording: false,
                recognition: null
            };

            const translations = {
                tr: {
                    appTitle: "Münazara Arenası",
                    appSubtitle: "Python & Flask Versiyonu",
                    topicSelectLabel: "1. Bir Münazara Konusu Seçin",
                    topicSelectPlaceholder: "Konu seç...",
                    topic1: "Yapay zeka insanlık için bir tehdit mi?",
                    topic2: "Üniversite eğitimi herkes için ücretsiz mi olmalı?",
                    topic3: "Sosyal medya toplumu olumlu yönde mi etkiliyor?",
                    topicCustom: "Kendi konumu yazmak istiyorum...",
                    customTopicPlaceholder: "Münazara konunuzu buraya yazın",
                    stanceSelectLabel: "2. Tarafınızı Belirleyin",
                    stanceFor: "Savunuyorum",
                    stanceAgainst: "Karşı Çıkıyorum",
                    startDebate: "Münazarayı Başlat",
                    topicLabel: "Konu",
                    messagePlaceholder: "Argümanınızı yazın...",
                    endDebate: "Münazarayı Bitir ve Rapor Al",
                    reportTitle: "Performans Raporu",
                    scoreLabel: "İkna Edicilik Puanı",
                    strongestArgument: "En Güçlü Argümanınız",
                    improvementArea: "Geliştirilmesi Gereken Nokta",
                    exampleSentence: "Örnek Cümleniz",
                    suggestion: "Öneri",
                    evidenceUsage: "Kanıt Kullanımı ve Destekleme",
                    generalComment: "Genel Yorum",
                    drawSchema: "Argüman Haritasını Çiz",
                    downloadPDF: "Raporu ve Haritayı İndir",
                    newDebate: "Yeni Münazara Başlat",
                    schemaTitle: "Argüman Haritası",
                    backToReport: "Rapora Geri Dön",
                    pdfLoading: "PDF oluşturuluyor...",
                    errorTopic: "Lütfen bir konu ve taraf seçin.",
                    errorSendMessage: "Mesaj gönderilemedi",
                    errorReport: "Rapor oluşturulamadı",
                    errorSchema: "Şema verisi sunucudan alınamadı.",
                    errorSchemaInvalid: "Yapay zeka geçerli bir şema formatı döndürmedi.",
                    errorSchemaRender: "Argüman haritası çizilirken bir hata oluştu.",
                    errorPDF: "PDF oluşturulurken bir hata oluştu",
                    loginTitle: "Giriş Yap",
                    registerTitle: "Kayıt Ol",
                    usernamePlaceholder: "Kullanıcı Adı",
                    passwordPlaceholder: "Şifre",
                    loginButton: "Giriş Yap",
                    registerButton: "Kayıt Ol",
                    guestButton: "Misafir Olarak Devam Et",
                    showRegister: "Hesabın yok mu? Kayıt ol",
                    showLogin: "Zaten hesabın var mı? Giriş yap",
                    historyTitle: "Münazara Geçmişi",
                    backToMain: "Ana Menüye Dön",
                    analyzeProfile: "Profilimi Analiz Et",
                    profileTitle: "Münazır Profili",
                    profileError: "Profil analizi için en az 3 münazara tamamlamanız gerekmektedir.",
                    progressChart: "Gelişim Grafiği",
                    commonFallacy: "En Sık Tekrarlanan Mantık Hatası",
                    debateStyle: "Münazara Stiliniz",
                    strength: "Güçlü Yönünüz",
                    weakness: "Geliştirilecek Yönünüz",
                    voiceStart: "Ses kaydını başlat",
                    voiceStop: "Ses kaydını durdur",
                    voiceNotSupported: "Ses tanıma desteklenmiyor"
                },
                en: {
                    appTitle: "Debate Arena",
                    topicSelectLabel: "1. Select a Debate Topic",
                    stanceFor: "I'm For",
                    stanceAgainst: "I'm Against",
                    startDebate: "Start Debate",
                    messagePlaceholder: "Write your argument...",
                    voiceStart: "Start voice recording",
                    voiceStop: "Stop voice recording",
                    voiceNotSupported: "Voice recognition not supported"
                }
            };

            const mainContent = document.querySelector('main');

            // Initialize Speech Recognition
            function initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    state.recognition = new SpeechRecognition();
                    state.recognition.continuous = true;
                    state.recognition.interimResults = true;
                    state.recognition.lang = state.lang === 'tr' ? 'tr-TR' : 'en-US';

                    state.recognition.onresult = function(event) {
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            }
                        }

                        if (finalTranscript) {
                            const messageInput = document.getElementById('message-input');
                            if (messageInput) {
                                messageInput.value = (messageInput.value + ' ' + finalTranscript).trim();
                            }
                        }
                    };

                    state.recognition.onerror = function(event) {
                        console.error('Speech recognition error:', event.error);
                        stopVoiceRecording();
                    };

                    state.recognition.onend = function() {
                        stopVoiceRecording();
                    };
                }
            }

            function startVoiceRecording() {
                if (state.recognition && !state.isRecording) {
                    state.isRecording = true;
                    state.recognition.start();

                    const voiceBtn = document.getElementById('voice-btn');
                    if (voiceBtn) {
                        voiceBtn.classList.add('recording');
                        voiceBtn.title = translations[state.lang].voiceStop;
                    }
                }
            }

            function stopVoiceRecording() {
                if (state.recognition && state.isRecording) {
                    state.isRecording = false;
                    state.recognition.stop();

                    const voiceBtn = document.getElementById('voice-btn');
                    if (voiceBtn) {
                        voiceBtn.classList.remove('recording');
                        voiceBtn.title = translations[state.lang].voiceStart;
                    }
                }
            }

            function setLanguage(lang) {
                state.lang = lang;
                localStorage.setItem('lang', lang);
                document.documentElement.lang = lang;

                // Update speech recognition language
                if (state.recognition) {
                    state.recognition.lang = lang === 'tr' ? 'tr-TR' : 'en-US';
                }

                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                            if (el.placeholder) el.placeholder = translation;
                        } else {
                            el.textContent = translation;
                        }
                    }
                });
                const langToggler = document.querySelector('[data-action="toggle-lang"]');
                if(langToggler) langToggler.textContent = lang === 'tr' ? 'EN' : 'TR';
            }

            function setTheme(theme) {
                state.theme = theme;
                localStorage.setItem('theme', theme);

                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon-light').classList.add('hidden');
                    document.getElementById('theme-icon-dark').classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('theme-icon-light').classList.remove('hidden');
                    document.getElementById('theme-icon-dark').classList.add('hidden');
                }

                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({ startOnLoad: false, theme: theme });
                }
            }

            function showScreen(htmlContent) {
                mainContent.innerHTML = htmlContent;
                setLanguage(state.lang);

                // Reinitialize speech recognition after screen change
                initSpeechRecognition();
            }

            function updateMessages() {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;
                messagesContainer.innerHTML = state.messages.map(msg => `
                    <div class="flex items-start gap-3 animate-fade-in ${msg.author === 'user' ? 'justify-end' : 'justify-start'}">
                        ${msg.author === 'ai' ? '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-100 dark:bg-cyan-900 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600 dark:text-cyan-400"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>' : ''}
                        <div class="max-w-md p-4 rounded-2xl ${msg.author === 'user' ? 'bg-gradient-to-br from-cyan-500 to-blue-600 text-white rounded-br-md' : 'ai-message-bg text-contrast rounded-bl-md border'}">
                            <p class="text-sm leading-relaxed" style="white-space: pre-wrap;">${msg.text}</p>
                        </div>
                        ${msg.author === 'user' ? '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-300"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>' : ''}
                    </div>
                `).join('');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function addMessage(author, text) {
                state.messages.push({ author, text });
                updateMessages();
            }

            function setLoading(isLoading, message = '') {
                document.querySelectorAll('[data-action]').forEach(el => el.disabled = isLoading);
                const messageInput = document.getElementById('message-input');
                if(messageInput) messageInput.disabled = isLoading;

                const messagesContainer = document.getElementById('messages-container');
                let loadingEl = document.getElementById('loading-indicator');
                if (isLoading) {
                    if (!loadingEl && messagesContainer) {
                        loadingEl = document.createElement('div');
                        loadingEl.id = 'loading-indicator';
                        loadingEl.innerHTML = `
                            <div class="flex items-start gap-3 justify-start">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-100 dark:bg-cyan-900 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600 dark:text-cyan-400"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>
                                <div class="max-w-md p-4 rounded-2xl ai-message-bg text-contrast rounded-bl-md border">
                                    <div class="flex items-center space-x-2"><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div></div>
                                    ${message ? `<p class="text-sm mt-2">${message}</p>` : ''}
                                </div>
                            </div>`;
                        messagesContainer.appendChild(loadingEl);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else {
                    if (loadingEl) loadingEl.remove();
                }
            }

            function renderLoginScreen() {
                const html = `
                    <div id="login-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-6">
                            <div class="text-center mb-6">
                                <h2 data-lang-key="loginTitle" class="text-3xl font-bold text-contrast">Giriş Yap</h2>
                                <p class="text-subtle mt-2">Hesabınıza giriş yapın veya misafir olarak devam edin</p>
                            </div>
                            <input id="login-username" type="text" data-lang-key="usernamePlaceholder" placeholder="Kullanıcı Adı" class="w-full p-4 custom-topic-bg rounded-xl text-contrast focus:ring-2 focus:ring-cyan-500 transition-all">
                            <input id="login-password" type="password" data-lang-key="passwordPlaceholder" placeholder="Şifre" class="w-full p-4 custom-topic-bg rounded-xl text-contrast focus:ring-2 focus:ring-cyan-500 transition-all">
                            <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                            <div class="space-y-3">
                                <button data-action="login" class="btn-primary w-full p-4 text-white font-bold rounded-xl transition-all"><span data-lang-key="loginButton">Giriş Yap</span></button>
                                <button data-action="guest-login" class="btn-secondary w-full p-4 text-white font-bold rounded-xl transition-all"><span data-lang-key="guestButton">Misafir Olarak Devam Et</span></button>
                            </div>
                            <p class="text-center text-sm"><button data-action="show-register" class="text-cyan-600 dark:text-cyan-400 hover:underline font-medium"><span data-lang-key="showRegister">Hesabın yok mu? Kayıt ol</span></button></p>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderRegisterScreen() {
                const html = `
                    <div id="register-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-6">
                            <div class="text-center mb-6">
                                <h2 data-lang-key="registerTitle" class="text-3xl font-bold text-contrast">Kayıt Ol</h2>
                                <p class="text-subtle mt-2">Yeni hesap oluşturun</p>
                            </div>
                            <input id="register-username" type="text" data-lang-key="usernamePlaceholder" placeholder="Kullanıcı Adı" class="w-full p-4 custom-topic-bg rounded-xl text-contrast focus:ring-2 focus:ring-cyan-500 transition-all">
                            <input id="register-password" type="password" data-lang-key="passwordPlaceholder" placeholder="Şifre" class="w-full p-4 custom-topic-bg rounded-xl text-contrast focus:ring-2 focus:ring-cyan-500 transition-all">
                            <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                            <button data-action="register" class="btn-primary w-full p-4 text-white font-bold rounded-xl transition-all"><span data-lang-key="registerButton">Kayıt Ol</span></button>
                            <p class="text-center text-sm"><button data-action="show-login" class="text-cyan-600 dark:text-cyan-400 hover:underline font-medium"><span data-lang-key="showLogin">Zaten hesabın var mı? Giriş yap</span></button></p>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function checkCanStart() {
                const topicSelect = document.getElementById('topic-select');
                const customTopicInput = document.getElementById('custom-topic-input');
                const startBtn = document.getElementById('start-debate-btn');
                const errorMessage = document.getElementById('error-message');

                if (!topicSelect || !startBtn) return;

                const isCustomTopic = topicSelect.value === 'custom';
                const customTopicValid = !isCustomTopic || (customTopicInput && customTopicInput.value.trim().length > 0);

                const canStart = state.stance && state.topic && customTopicValid;
                startBtn.disabled = !canStart;

                if (errorMessage) {
                    errorMessage.textContent = canStart ? '' : translations[state.lang].errorTopic;
                }
            }

            function renderTopicScreen() {
                const html = `
                    <div id="topic-screen" class="flex flex-col h-full justify-center animate-fade-in">
                        <div class="topic-screen-bg space-y-8">
                            <!-- Learning Paths Banner -->
                            <div class="p-6 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 rounded-2xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="font-bold text-xl mb-2">Kişiselleştirilmiş Öğrenme</h3>
                                        <p class="text-white/90 text-sm">Seviyenize uygun öğrenme yolları keşfedin</p>
                                    </div>
                                    <a href="/ogrenme-yollari" class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105">
                                        Başla →
                                    </a>
                                </div>
                            </div>

                            <div>
                                <label for="topic-select" data-lang-key="topicSelectLabel" class="block text-lg font-semibold text-contrast mb-4">1. Bir Münazara Konusu Seçin</label>
                                <select id="topic-select" class="w-full p-4 select-bg rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast text-lg">
                                    <option value="" disabled selected data-lang-key="topicSelectPlaceholder">Konu seç...</option>
                                    <option value="Yapay zeka insanlık için bir tehdit mi?" data-lang-key="topic1">Yapay zeka insanlık için bir tehdit mi?</option>
                                    <option value="Üniversite eğitimi herkes için ücretsiz mi olmalı?" data-lang-key="topic2">Üniversite eğitimi herkes için ücretsiz mi olmalı?</option>
                                    <option value="Sosyal medya toplumu olumlu yönde mi etkiliyor?" data-lang-key="topic3">Sosyal medya toplumu olumlu yönde mi etkiliyor?</option>
                                    <option value="custom" data-lang-key="topicCustom">Kendi konumu yazmak istiyorum...</option>
                                </select>
                            </div>
                            <div id="custom-topic-container" class="hidden">
                                <input type="text" id="custom-topic-input" data-lang-key="customTopicPlaceholder" placeholder="Münazara konunuzu buraya yazın" class="w-full p-4 custom-topic-bg rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast text-lg" />
                            </div>
                            <div>
                                <h3 data-lang-key="stanceSelectLabel" class="block text-lg font-semibold text-contrast mb-4">2. Tarafınızı Belirleyin</h3>
                                <div class="grid grid-cols-2 gap-6">
                                    <button data-action="set-stance" data-stance="savunuyorum" class="p-6 rounded-xl text-center transition-all card-bg hover:bg-gray-200 dark:hover:bg-gray-600 font-semibold text-lg border-2 border-transparent hover:border-green-400 hover:shadow-lg">
                                        <span data-lang-key="stanceFor">Savunuyorum</span>
                                    </button>
                                    <button data-action="set-stance" data-stance="karşı çıkıyorum" class="p-6 rounded-xl text-center transition-all card-bg hover:bg-gray-200 dark:hover:bg-gray-600 font-semibold text-lg border-2 border-transparent hover:border-red-400 hover:shadow-lg">
                                        <span data-lang-key="stanceAgainst">Karşı Çıkıyorum</span>
                                    </button>
                                </div>
                            </div>
                            <p id="error-message" class="text-red-500 dark:text-red-400 text-sm text-center h-4"></p>
                            <button data-action="start-debate" id="start-debate-btn" class="btn-primary w-full p-5 text-white font-bold rounded-xl text-xl transition-all disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                                <span data-lang-key="startDebate">Münazarayı Başlat</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                const topicSelect = document.getElementById('topic-select');
                const customTopicInput = document.getElementById('custom-topic-input');

                topicSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('custom-topic-container').classList.remove('hidden');
                        customTopicInput.focus();
                        state.topic = customTopicInput.value.trim();
                    } else {
                        document.getElementById('custom-topic-container').classList.add('hidden');
                        state.topic = this.value;
                    }
                    checkCanStart();
                });

                if (customTopicInput) {
                    customTopicInput.addEventListener('input', function() {
                        state.topic = this.value;
                        checkCanStart();
                    });
                }

                state.topic = topicSelect.value === 'custom' ? '' : topicSelect.value;
                checkCanStart();
            }

            function renderDebateScreen() {
                const html = `
                    <div id="debate-screen" class="flex flex-col h-full">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 -mx-6 -mt-6 mb-6 rounded-t-2xl">
                            <h3 id="debate-topic-header" class="text-center font-bold text-lg text-contrast"><span data-lang-key="topicLabel">Konu</span>: <span class="text-cyan-600 dark:text-cyan-400">${state.topic}</span></h3>
                        </div>
                        <div id="messages-container" class="flex-grow overflow-y-auto pr-4 -mr-4 space-y-6">
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center space-x-3 mb-4">
                                <input type="text" id="message-input" data-lang-key="messagePlaceholder" placeholder="Argümanınızı yazın..." class="flex-grow p-4 message-input-bg rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-contrast text-lg" />
                                <button id="voice-btn" class="p-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl transition-all" title="${translations[state.lang].voiceStart}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                        <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
                                        <line x1="12" x2="12" y1="19" y2="22"/>
                                        <line x1="8" x2="16" y1="22" y2="22"/>
                                    </svg>
                                </button>
                                <button data-action="send-message" id="send-btn" class="btn-primary p-4 text-white rounded-xl transition-all disabled:bg-gray-500 dark:disabled:bg-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none">
                                        <path d="m22 2-7 20-4-9-9-4Z"/>
                                        <path d="M22 2 11 13"/>
                                    </svg>
                                </button>
                            </div>
                            <button data-action="end-debate" id="end-debate-btn" class="btn-danger w-full p-4 text-white rounded-xl font-bold transition-all disabled:bg-gray-500 dark:disabled:bg-gray-600">
                                <span data-lang-key="endDebate">Münazarayı Bitir ve Rapor Al</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                updateMessages();

                // Voice button functionality
                const voiceBtn = document.getElementById('voice-btn');
                if (voiceBtn) {
                    voiceBtn.addEventListener('click', function() {
                        if (state.isRecording) {
                            stopVoiceRecording();
                        } else {
                            startVoiceRecording();
                        }
                    });
                }

                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            document.querySelector('[data-action="send-message"]').click();
                        }
                    });
                }
            }

            function renderReportScreen(report) {
                state.currentReport = report;
                const score = report.iknaEdicilikPuani || 0;

                const html = `
                    <div id="report-screen-content" class="flex flex-col h-full justify-start pt-8 animate-fade-in">
                        <div id="report-content" class="space-y-8">
                            <h2 data-lang-key="reportTitle" class="text-4xl font-bold text-center bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent">Performans Raporu</h2>
                            <div class="relative flex justify-center items-center">
                                <svg class="transform -rotate-90" width="140" height="140" viewBox="0 0 140 140">
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="currentColor" class="text-gray-200 dark:text-gray-700" stroke-width="8" />
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="url(#gradient)" stroke-width="8" pathLength="1" stroke-dasharray="1" stroke-dashoffset="${1 - (score / 10)}" stroke-linecap="round" />
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <span class="absolute text-4xl font-bold">${score}<span class="text-xl">/10</span></span>
                            </div>
                            <p data-lang-key="scoreLabel" class="text-center text-xl font-semibold text-subtle">İkna Edicilik Puanı</p>
                            <div class="space-y-6">
                                <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border border-green-200 dark:border-green-800">
                                    <h3 data-lang-key="strongestArgument" class="font-bold text-green-700 dark:text-green-400 mb-3 text-lg">En Güçlü Argümanınız</h3>
                                    <p class="text-sm leading-relaxed">${report.enGucluArguman || '...'}</p>
                                </div>
                                <div class="p-6 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-2xl border border-yellow-200 dark:border-yellow-800">
                                    <h3 class="font-bold text-yellow-700 dark:text-yellow-400 mb-3 text-lg"><span data-lang-key="improvementArea">Geliştirilmesi Gereken Nokta</span>: ${report.gelistirilmesiGerekenNokta?.tespitEdilenHataTuru || 'Genel'}</h3>
                                    <p class="text-sm text-subtle mb-3"><em>${report.gelistirilmesiGerekenNokta?.hataTanimi || ''}</em></p>
                                    <div class="bg-white/50 dark:bg-gray-800/50 p-4 rounded-xl mb-3">
                                        <p class="text-sm"><strong><span data-lang-key="exampleSentence">Örnek Cümleniz</span>:</strong></p>
                                        <p class="text-sm italic mt-1">"${report.gelistirilmesiGerekenNokta?.ornekCumle || '...'}"</p>
                                    </div>
                                    <p class="text-sm"><strong><span data-lang-key="suggestion">Öneri</span>:</strong> ${report.gelistirilmesiGerekenNokta?.onerilenGelistirme || '...'}</p>
                                </div>
                                <div class="p-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-2xl border border-indigo-200 dark:border-indigo-800">
                                    <h3 data-lang-key="evidenceUsage" class="font-bold text-indigo-700 dark:text-indigo-400 mb-3 text-lg">Kanıt Kullanımı ve Destekleme</h3>
                                    <p class="text-sm leading-relaxed">${report.kanitKullanimi || '...'}</p>
                                </div>
                                <div class="p-6 bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-2xl border border-cyan-200 dark:border-cyan-800">
                                    <h3 data-lang-key="generalComment" class="font-bold text-cyan-700 dark:text-cyan-400 mb-3 text-lg">Genel Yorum</h3>
                                    <p class="text-sm leading-relaxed">${report.genelYorum || '...'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <button data-action="draw-schema" class="btn-secondary w-full p-4 text-white rounded-xl font-bold transition-all"><span data-lang-key="drawSchema">Argüman Haritasını Çiz</span></button>
                            <button data-action="download-pdf" class="w-full p-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-xl font-bold transition-all"><span data-lang-key="downloadPDF">Raporu ve Haritayı İndir</span></button>
                            <button data-action="new-debate" class="btn-primary w-full p-4 text-white rounded-xl font-bold transition-all"><span data-lang-key="newDebate">Yeni Münazara Başlat</span></button>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderSchemaScreen(schemaData) {
                state.currentSchema = schemaData;
                const html = `
                    <div id="schema-screen" class="flex flex-col h-full">
                        <h2 data-lang-key="schemaTitle" class="text-3xl font-bold text-center bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent mb-6">Argüman Haritası</h2>
                        <div id="schema-container" class="flex-grow bg-white dark:bg-gray-900 p-6 rounded-2xl overflow-auto border">
                        </div>
                        <div class="mt-6">
                            <button data-action="back-to-report" class="btn-primary w-full p-4 text-white rounded-xl font-bold transition-all">
                                <span data-lang-key="backToReport">Rapora Geri Dön</span>
                            </button>
                        </div>
                    </div>
                `;
                showScreen(html);
                const schemaContainer = document.getElementById('schema-container');

                try {
                    if (schemaData && schemaData.schema) {
                        if (typeof mermaid !== 'undefined') {
                            mermaid.render('mermaid-graph', schemaData.schema).then(({svg}) => {
                                schemaContainer.innerHTML = svg;
                            }).catch(error => {
                                console.error("Mermaid render error:", error);
                                schemaContainer.innerHTML = `<p class="text-red-500">${translations[state.lang].errorSchemaRender}</p><p class="text-xs text-subtle mt-2">${error.message}</p>`;
                            });
                        } else {
                            throw new Error("Mermaid library not loaded");
                        }
                    } else {
                        throw new Error(translations[state.lang].errorSchemaInvalid);
                    }
                } catch (error) {
                    console.error("Schema render error:", error);
                    schemaContainer.innerHTML = `<p class="text-red-500">${translations[state.lang].errorSchemaRender}</p><p class="text-xs text-subtle mt-2">${error.message}</p>`;
                }
            }

            function renderHistoryScreen(history) {
                const historyItems = history.map(item => `
                    <div data-action="view-history-item" data-id="${item.id}" class="p-6 card-bg rounded-2xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-all hover:shadow-lg border">
                        <p class="font-bold text-contrast text-lg">${item.topic}</p>
                        <p class="text-sm text-subtle mt-2">${item.timestamp}</p>
                        <div class="flex items-center mt-3">
                            <div class="w-8 h-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full mr-3"></div>
                            <span class="text-sm font-medium">${item.report?.iknaEdicilikPuani || 0}/10 puan</span>
                        </div>
                    </div>
                `).join('');

                const html = `
                    <div id="history-screen" class="flex flex-col h-full animate-fade-in">
                        <h2 data-lang-key="historyTitle" class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent">Münazara Geçmişi</h2>
                        <div class="flex-grow space-y-4 overflow-y-auto">
                            ${history.length > 0 ? historyItems : `<div class="text-center py-12"><p class="text-subtle text-lg">Henüz bir münazara tamamlamadınız.</p></div>`}
                        </div>
                        <div class="mt-6 space-y-4">
                            <button data-action="analyze-profile" class="btn-secondary w-full p-4 text-white font-bold rounded-xl transition-all disabled:bg-gray-500" ${history.length < 3 ? 'disabled' : ''}><span data-lang-key="analyzeProfile">Profilimi Analiz Et</span></button>
                            <button data-action="back-to-main" class="btn-primary w-full p-4 text-white font-bold rounded-xl transition-all"><span data-lang-key="backToMain">Ana Menüye Dön</span></button>
                        </div>
                    </div>
                `;
                showScreen(html);
            }

            function renderProfileScreen(profile) {
                const html = `
                    <div id="profile-screen" class="flex flex-col h-full animate-fade-in">
                        <h2 data-lang-key="profileTitle" class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent">Münazır Profili</h2>
                        <div class="flex-grow space-y-6 overflow-y-auto p-1">
                            <div class="p-6 card-bg rounded-2xl border">
                                <h3 data-lang-key="progressChart" class="font-bold text-contrast mb-4 text-lg">Gelişim Grafiği</h3>
                                <canvas id="progressChart"></canvas>
                            </div>
                            <div class="p-6 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-2xl border border-yellow-200 dark:border-yellow-800">
                                <h3 data-lang-key="commonFallacy" class="font-bold text-yellow-700 dark:text-yellow-400 mb-3 text-lg">En Sık Tekrarlanan Mantık Hatası</h3>
                                <p class="font-bold text-yellow-600 dark:text-yellow-300 text-xl">${profile.enSikHata?.hataTuru || 'Belirlenmedi'}</p>
                                <p class="text-sm text-subtle mt-2">${profile.enSikHata?.tavsiye || 'Tavsiye bulunamadı.'}</p>
                            </div>
                            <div class="p-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-2xl border border-indigo-200 dark:border-indigo-800">
                                <h3 data-lang-key="debateStyle" class="font-bold text-indigo-700 dark:text-indigo-400 mb-3 text-lg">Münazara Stiliniz</h3>
                                <p class="text-sm leading-relaxed">${profile.munazaraStili || 'Analiz ediliyor...'}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border border-green-200 dark:border-green-800">
                                    <h3 data-lang-key="strength" class="font-bold text-green-700 dark:text-green-400 mb-3 text-lg">Güçlü Yönünüz</h3>
                                    <p class="text-sm leading-relaxed">${profile.gucluYon || 'Analiz ediliyor...'}</p>
                                </div>
                                <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border border-red-200 dark:border-red-800">
                                    <h3 data-lang-key="weakness" class="font-bold text-red-700 dark:text-red-400 mb-3 text-lg">Geliştirilecek Yönünüz</h3>
                                    <p class="text-sm leading-relaxed">${profile.gelistirilecekYon || 'Analiz ediliyor...'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button data-action="show-history" class="btn-primary w-full p-4 text-white font-bold rounded-xl transition-all">Geri Dön</button>
                        </div>
                    </div>
                `;
                showScreen(html);

                const ctx = document.getElementById('progressChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: state.history.map((_, i) => `Münazara ${i + 1}`),
                        datasets: [{
                            label: 'İkna Puanı',
                            data: state.history.map(d => d.report?.iknaEdicilikPuani || 0),
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            async function handleAction(event) {
                const target = event.target.closest('[data-action]');
                if (!target || target.disabled) return;

                const action = target.dataset.action;

                if (action === 'toggle-theme') {
                    setTheme(state.theme === 'dark' ? 'light' : 'dark');
                }

                if (action === 'toggle-lang') {
                    setLanguage(state.lang === 'tr' ? 'en' : 'tr');
                }

                if (action === 'set-stance') {
                    state.stance = target.dataset.stance;

                    document.querySelectorAll('[data-action="set-stance"]').forEach(btn => {
                        btn.classList.remove('bg-green-500', 'dark:bg-green-600', 'border-green-400', 'text-white', 'shadow-lg');
                        btn.classList.remove('bg-red-500', 'dark:bg-red-600', 'border-red-400');
                        btn.classList.add('card-bg', 'hover:bg-gray-200', 'dark:hover:bg-gray-600', 'border-transparent');
                    });

                    target.classList.remove('card-bg', 'hover:bg-gray-200', 'dark:hover:bg-gray-600', 'border-transparent');
                    target.classList.add(
                        state.stance === 'savunuyorum' ? 'bg-green-500' : 'bg-red-500',
                        state.stance === 'savunuyorum' ? 'dark:bg-green-600' : 'dark:bg-red-600',
                        state.stance === 'savunuyorum' ? 'border-green-400' : 'border-red-400',
                        'text-white',
                        'shadow-lg'
                    );

                    checkCanStart();
                }

                if (action === 'start-debate') {
                    const topicSelect = document.getElementById('topic-select');
                    const customTopicInput = document.getElementById('custom-topic-input');
                    const finalTopic = topicSelect.value === 'custom' ? customTopicInput?.value?.trim() : topicSelect.value;
                    if (!finalTopic || !state.stance) {
                        checkCanStart();
                        return;
                    }
                    state.topic = finalTopic;
                    state.messages = [];
                    renderDebateScreen();
                }

                if (action === 'send-message') {
                    const messageInput = document.getElementById('message-input');
                    const text = messageInput?.value?.trim();
                    if (!text) return;

                    addMessage('user', text);
                    messageInput.value = '';
                    setLoading(true);

                    try {
                        const response = await fetch('/api/debate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                topic: state.topic,
                                stance: state.stance,
                                messages: state.messages,
                                lang: state.lang
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({error: translations[state.lang].errorSendMessage}));
                            throw new Error(errData.error || translations[state.lang].errorSendMessage);
                        }

                        const data = await response.json();
                        addMessage('ai', data.reply);

                    } catch (error) {
                        addMessage('ai', `${translations[state.lang].errorSendMessage}: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'end-debate') {
                    setLoading(true);
                    try {
                        const response = await fetch('/api/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                messages: state.messages,
                                topic: state.topic,
                                lang: state.lang
                            })
                        });
                        if (!response.ok) {
                             const errData = await response.json().catch(() => ({error: translations[state.lang].errorReport}));
                             throw new Error(errData.error || translations[state.lang].errorReport);
                        }
                        const report = await response.json();
                        renderReportScreen(report);
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'new-debate' || action === 'back-to-main') {
                    renderTopicScreen();
                }

                if (action === 'back-to-report') {
                    if (state.currentReport) {
                        renderReportScreen(state.currentReport);
                    } else {
                        renderTopicScreen();
                    }
                }

                if (action === 'draw-schema') {
                    setLoading(true);
                     try {
                        const response = await fetch('/api/schema', {
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify({
                               messages: state.messages,
                               lang: state.lang
                           })
                        });
                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({error: translations[state.lang].errorSchema}));
                            throw new Error(errData.error || translations[state.lang].errorSchema);
                        }
                        const schemaData = await response.json();
                        renderSchemaScreen(schemaData);
                    } catch (error) {
                        console.error("Schema error:", error);
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'download-pdf') {
                    setLoading(true, translations[state.lang].pdfLoading);
                    try {
                        if (!state.currentReport) {
                             alert("PDF oluşturmak için önce bir rapor oluşturulmalıdır.");
                             setLoading(false);
                             return;
                        }

                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        // Set PDF metadata
                        pdf.setProperties({
                            title: 'Münazara Raporu',
                            subject: 'Performans Analizi',
                            author: 'Münazara Arenası',
                            creator: 'Münazara Arenası'
                        });

                        const reportElement = document.getElementById('report-content');
                        if (!reportElement) {
                            throw new Error("Rapor içeriği bulunamadı");
                        }

                        // Create a temporary container with white background for PDF
                        const tempContainer = document.createElement('div');
                        tempContainer.style.cssText = `
                            position: absolute;
                            top: -9999px;
                            left: -9999px;
                            width: 800px;
                            background: white;
                            padding: 40px;
                            font-family: Arial, sans-serif;
                            color: #333;
                        `;

                        // Clone and clean the report content
                        const reportClone = reportElement.cloneNode(true);

                        // Remove any dark mode classes and ensure white background
                        const elementsToClean = reportClone.querySelectorAll('*');
                        elementsToClean.forEach(el => {
                            if (el.classList) {
                                el.classList.remove('dark:bg-gray-700', 'dark:text-white', 'dark:text-gray-300', 'dark:border-gray-800');
                            }
                            if (el.style) {
                                el.style.backgroundColor = '';
                                el.style.color = '#333';
                            }
                        });

                        tempContainer.appendChild(reportClone);
                        document.body.appendChild(tempContainer);

                        const reportCanvas = await html2canvas(tempContainer, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            logging: false,
                            allowTaint: false,
                            foreignObjectRendering: false
                        });

                        document.body.removeChild(tempContainer);

                        const reportImgData = reportCanvas.toDataURL('image/jpeg', 0.95);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (reportCanvas.height * pdfWidth) / reportCanvas.width;

                        // Add report to PDF
                        pdf.addImage(reportImgData, 'JPEG', 0, 0, pdfWidth, Math.min(pdfHeight, pdf.internal.pageSize.getHeight()));

                        // Add schema if available
                        if (state.currentSchema && state.currentSchema.schema) {
                            pdf.addPage();

                            const schemaContainer = document.createElement('div');
                            schemaContainer.style.cssText = `
                                position: absolute;
                                top: -9999px;
                                left: -9999px;
                                width: 800px;
                                background: white;
                                padding: 20px;
                            `;
                            document.body.appendChild(schemaContainer);

                            try {
                                if (typeof mermaid !== 'undefined') {
                                    const {svg} = await mermaid.render('pdf-mermaid-' + Date.now(), state.currentSchema.schema);
                                    schemaContainer.innerHTML = svg;

                                    const schemaCanvas = await html2canvas(schemaContainer, {
                                        scale: 2,
                                        useCORS: true,
                                        backgroundColor: '#ffffff',
                                        logging: false
                                    });

                                    const schemaImgData = schemaCanvas.toDataURL('image/jpeg', 0.95);
                                    const schemaPdfHeight = (schemaCanvas.height * pdfWidth) / schemaCanvas.width;
                                    pdf.addImage(schemaImgData, 'JPEG', 0, 0, pdfWidth, Math.min(schemaPdfHeight, pdf.internal.pageSize.getHeight()));
                                }
                            } catch (schemaError) {
                                console.error("Schema PDF error:", schemaError);
                                // Add text fallback if schema fails
                                pdf.setFontSize(16);
                                pdf.text('Argüman Haritası', 20, 30);
                                pdf.setFontSize(12);
                                pdf.text('Argüman haritası oluşturulurken bir hata oluştu.', 20, 50);
                            }

                            document.body.removeChild(schemaContainer);
                        }

                        // Save the PDF
                        const filename = `munazara-raporu-${new Date().toISOString().split('T')[0]}.pdf`;
                        pdf.save(filename);

                    } catch (error) {
                        console.error("PDF Oluşturma Hatası:", error);
                        alert(`${translations[state.lang].errorPDF}: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                }

                if (action === 'show-register') {
                    renderRegisterScreen();
                }

                if (action === 'show-login') {
                    renderLoginScreen();
                }

                if (action === 'guest-login') {
                    document.getElementById('user-info').classList.add('hidden');
                    renderTopicScreen();
                }

                if (action === 'login' || action === 'register') {
                    const isLogin = action === 'login';
                    const endpoint = isLogin ? '/api/login' : '/api/register';
                    const usernameEl = document.getElementById(isLogin ? 'login-username' : 'register-username');
                    const passwordEl = document.getElementById(isLogin ? 'login-password' : 'register-password');
                    const errorEl = document.getElementById('auth-error');

                    const username = usernameEl?.value;
                    const password = passwordEl?.value;

                    if (!username || !password) {
                        if (errorEl) errorEl.textContent = "Kullanıcı adı ve şifre gereklidir.";
                        return;
                    }

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password })
                        });
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Bir hata oluştu.');
                        }

                        if (isLogin) {
                            document.getElementById('user-info').classList.remove('hidden');
                            document.getElementById('username-display').textContent = data.username;
                            renderTopicScreen();
                        } else {
                            alert('Kayıt başarılı! Lütfen giriş yapın.');
                            renderLoginScreen();
                        }

                    } catch (error) {
                        if (errorEl) errorEl.textContent = error.message;
                    }
                }

                if (action === 'logout') {
                    await fetch('/api/logout', { method: 'POST' });
                    document.getElementById('user-info').classList.add('hidden');
                    renderLoginScreen();
                }

                if (action === 'show-history') {
                    try {
                        const response = await fetch('/api/history');
                        if (!response.ok) {
                            const data = await response.json().catch(() => null);
                            alert(data?.error || 'Geçmiş verileri alınamadı.');
                            if (response.status === 401) {
                                renderLoginScreen();
                            }
                            return;
                        }
                        const historyData = await response.json();
                        state.history = historyData;
                        renderHistoryScreen(historyData);
                    } catch (error) {
                        console.error('History fetch error:', error);
                    }
                }

                if (action === 'view-history-item') {
                    const debateId = parseInt(target.dataset.id);
                    const debate = state.history.find(d => d.id === debateId);
                    if (debate) {
                        renderReportScreen(debate.report);
                        state.currentSchema = debate.schema;
                    }
                }

                if(action === 'analyze-profile') {
                    setLoading(true);
                    try {
                        const response = await fetch(`/api/profile?lang=${state.lang}`);
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || "Profil analizi yapılamadı.");
                        }
                        renderProfileScreen(data);
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        setLoading(false);
                    }
                }
            }

            async function initApp() {
                const savedLang = localStorage.getItem('lang') || 'tr';
                const savedTheme = localStorage.getItem('theme') || 'light';

                setLanguage(savedLang);
                setTheme(savedTheme);

                // Initialize speech recognition
                initSpeechRecognition();

                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({ startOnLoad: false, theme: savedTheme });
                }

                document.body.addEventListener('click', handleAction);

                // Theme toggle event
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    setTheme(state.theme === 'dark' ? 'light' : 'dark');
                });

                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    if (data.logged_in) {
                        document.getElementById('user-info').classList.remove('hidden');
                        document.getElementById('username-display').textContent = data.username;
                        renderTopicScreen();
                    } else {
                        renderLoginScreen();
                    }
                } catch (error) {
                    console.error("Could not check status:", error);
                    renderLoginScreen();
                }
            }

            initApp();
        });
    </script>
</body>
</html>